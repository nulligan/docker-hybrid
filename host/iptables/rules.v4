#!/bin/bash

I=/usr/sbin/iptables

$I -t nat -D POSTROUTING   -s 100.64.0.0/10                                                           -j HB_NAT
$I        -D INPUT         -s 100.64.0.0/10                                                           -j HB_INPUT   \
          &> /dev/null
$I        -D INPUT         -d 100.64.0.0/10                                                           -j HB_INPUT   \
          &> /dev/null
$I        -D FORWARD       -s 100.64.0.0/10                                                           -j HB_FORWARD \
          &> /dev/null
$I        -D FORWARD       -d 100.64.0.0/10                                                           -j HB_FORWARD \
          &> /dev/null
$I        -D OUTPUT        -s 100.64.0.0/10                                                           -j HB_OUTPUT  \
          &> /dev/null
$I        -D OUTPUT        -d 100.64.0.0/10                                                           -j HB_OUTPUT  \
          &> /dev/null

$I -t nat -F HB_NAT                    &> /dev/null
$I        -F HB_INPUT                  &> /dev/null
$I        -F HB_FORWARD                &> /dev/null
$I        -F HB_OUTPUT                 &> /dev/null

$I -t nat -X HB_NAT                    &> /dev/null
$I        -X HB_INPUT                  &> /dev/null
$I        -X HB_FORWARD                &> /dev/null
$I        -X HB_OUTPUT                 &> /dev/null

$I -t nat -N HB_NAT
$I        -N HB_INPUT
$I        -N HB_FORWARD
$I        -N HB_OUTPUT

$I -t nat -A HB_NAT        -s 100.64.48.0/20   -o $1                                                  -j MASQUERADE
$I        -A HB_INPUT      -s 100.64.48.0/20   -d 100.64.48.0/20 -m state --state RELATED,ESTABLISHED -j ACCEPT
$I        -A HB_INPUT      -s 100.64.48.0/20   -d 100.64.48.0/20 -p udp -m udp --dport 53             -j ACCEPT
$I        -A HB_FORWARD    -s 100.64.0.0/20    -d 100.64.16.0/20                                      -j ACCEPT
$I        -A HB_FORWARD    -s 100.64.48.0/20   -d 100.64.16.0/20                                      -j ACCEPT
$I        -A HB_FORWARD    -s 100.64.16.0/20   -d 100.64.0.0/20  -m state --state RELATED,ESTABLISHED -j ACCEPT
$I        -A HB_FORWARD    -s 100.64.16.0/20   -d 100.64.48.0/20 -m state --state RELATED,ESTABLISHED -j ACCEPT
$I        -A HB_FORWARD    -s 100.64.48.0/20 ! -d 100.64.0.0/17                                       -j ACCEPT
$I        -A HB_OUTPUT     -s 100.64.48.0/20   -d 100.64.48.0/20                                      -j ACCEPT

$I        -A HB_FORWARD -m limit --limit 2/min                                                        -j LOG \
          --log-prefix "4_HB_FWD dropped: "
$I        -A HB_INPUT   -m limit --limit 2/min                                                        -j LOG \
          --log-prefix "4_HB_IN dropped: "
$I        -A HB_OUTPUT  -m limit --limit 2/min                                                        -j LOG \
          --log-prefix "4_HB_OUT dropped: "
$I        -A HB_FORWARD                                                                               -j DROP
$I        -A HB_INPUT                                                                                 -j DROP
$I        -A HB_OUTPUT                                                                                -j DROP

$I        -I INPUT 1       -s 100.64.0.0/10                                                           -j HB_INPUT
$I        -I INPUT 1       -d 100.64.0.0/10                                                           -j HB_INPUT

$I        -I FORWARD 1     -s 100.64.0.0/10                                                           -j HB_FORWARD
$I        -I FORWARD 1     -d 100.64.0.0/10                                                           -j HB_FORWARD

$I        -I OUTPUT 1      -s 100.64.0.0/10                                                           -j HB_OUTPUT
$I        -I OUTPUT 1      -d 100.64.0.0/10                                                           -j HB_OUTPUT

$I -t nat -I POSTROUTING 1 -s 100.64.0.0/10                                                           -j HB_NAT
